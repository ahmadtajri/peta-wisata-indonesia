(()=>{"use strict";const e={init({button:e,drawer:t,content:n}){if(!e||!t)return void console.error("DrawerInitiator: Button or drawer element not found");this._createOverlay(t),e.addEventListener("click",e=>{e.stopPropagation(),this._toggleDrawer(t),console.log("Hamburger clicked, drawer toggled")});const o=t.querySelectorAll("a");console.log("Found nav links:",o.length),o.forEach((e,n)=>{e.addEventListener("click",o=>{console.log(`Nav link ${n} clicked:`,e.href),setTimeout(()=>{this._closeDrawer(t)},100)})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this._closeDrawer(t)}),console.log("Drawer initialized ‚úÖ")},_toggleDrawer(e){const t=document.getElementById("drawer-overlay"),n=document.getElementById("hamburgerButton");e.classList.contains("open")?this._closeDrawer(e):(e.classList.add("open"),t?.classList.add("open"),n?.classList.add("active"),document.body.style.overflow="hidden",console.log("Drawer opened"))},_closeDrawer(e){const t=document.getElementById("drawer-overlay"),n=document.getElementById("hamburgerButton");e.classList.remove("open"),t?.classList.remove("open"),n?.classList.remove("active"),document.body.style.overflow="",console.log("Drawer closed")},_createOverlay(e){if(document.getElementById("drawer-overlay"))return;const t=document.createElement("div");t.id="drawer-overlay",t.className="drawer-overlay",document.body.appendChild(t),t.addEventListener("click",()=>{console.log("Overlay clicked"),this._closeDrawer(e)}),console.log("Overlay created")}},t=class{static parseActiveUrlWithCombiner(){const e=window.location.hash.slice(1).toLowerCase(),t=this._urlSplitter(e);let n="/";return t.resource&&(n=`/${t.resource}`,t.id&&(n+="/:id"),t.verb&&(n+=`/${t.verb}`)),n}static parseActiveUrlWithoutCombiner(){const e=window.location.hash||"",t=e.startsWith("#")?e.slice(1).toLowerCase():e.toLowerCase();return this._urlSplitter(t)}static _urlSplitter(e){const t=e.replace(/\/+/g,"/").split("/").filter(Boolean);return{resource:t[0]||null,id:t[1]||null,verb:t[2]||null}}},n="https://story-api.dicoding.dev/v1/",o={REGISTER:"register",LOGIN:"login",ALL_STORIES:"stories",ADD_STORY:"stories",DETAIL_STORY:e=>`stories/${e}`},a={DEFAULT_COORDINATE:[-6.2,106.816666],DEFAULT_ZOOM:10},i={PUBLIC_VAPID_KEY:"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",SERVER_URL:"https://story-api.dicoding.dev/v1/notifications"},r="dicoding_story_user",s=e=>{localStorage.setItem(r,JSON.stringify(e))},l=()=>{const e=localStorage.getItem(r);return e?JSON.parse(e):null},c=class{static async registerUser({name:e,email:t,password:a}){try{const i=await fetch(`${n}${o.REGISTER}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:a})}),r=await i.json();if(!i.ok)throw new Error(r.message);return r}catch(e){throw console.error("Register Error:",e),e}}static async loginUser({email:e,password:t}){try{const a=await fetch(`${n}${o.LOGIN}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),i=await a.json();if(!a.ok)throw new Error(i.message);return s({name:i.loginResult.name,email:e,token:i.loginResult.token}),i}catch(e){throw console.error("Login Error:",e),e}}static async getAllStories(){try{const e=l();if(!e||!e.token)throw new Error("User belum login.");const t=await fetch(`${n}${o.ALL_STORIES}?t=${Date.now()}`,{headers:{Authorization:`Bearer ${e.token}`}}),a=await t.json();if(!t.ok)throw new Error(a.message);return a.listStory}catch(e){throw console.error("Get Stories Error:",e),e}}static async addStory({description:e,photo:t,lat:a,lon:i}){try{const r=l();if(!r||!r.token)throw new Error("User belum login.");const s=new FormData;s.append("description",e),s.append("photo",t),a&&i&&(s.append("lat",a),s.append("lon",i));const c=await fetch(`${n}${o.ADD_STORY}`,{method:"POST",headers:{Authorization:`Bearer ${r.token}`},body:s}),d=await c.json();if(!c.ok)throw new Error(d.message);return d}catch(e){throw console.error("Add Story Error:",e),e}}static async getStoryDetail(e){try{const t=l();if(console.log("[DEBUG] Token user:",t?.token),!t||!t.token)throw new Error("User belum login.");const a=await fetch(`${n}${o.DETAIL_STORY(e)}?t=${Date.now()}`,{headers:{Authorization:`Bearer ${t.token}`}}),i=await a.json();if(!a.ok)throw new Error(i.message||"Story not found.");return i.story}catch(e){throw console.error("Get Story Detail Error:",e),e}}static async getUserProfile(){return l()||null}},d="favorites",u=()=>new Promise((e,t)=>{const n=indexedDB.open("peta-wisata-db",1);n.onerror=()=>{t(new Error("Failed to open database"))},n.onsuccess=t=>{e(t.target.result)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(d)||t.createObjectStore(d,{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}}),m={async addFavorite(e){try{const t=await u(),n={id:e.id,name:e.name,description:e.description,photoUrl:e.photoUrl,lat:e.lat,lon:e.lon,createdAt:e.createdAt||(new Date).toISOString()};return new Promise((o,a)=>{const i=t.transaction([d],"readwrite").objectStore(d).put(n);i.onsuccess=()=>{console.log("Story added to favorites:",n),o(e.id)},i.onerror=()=>{a(new Error("Failed to add favorite"))}})}catch(e){throw console.error("Error adding to favorites:",e),e}},async getAllFavorites(){try{const e=await u();return new Promise((t,n)=>{const o=e.transaction([d],"readonly").objectStore(d).getAll();o.onsuccess=()=>{console.log("All favorites:",o.result),t(o.result)},o.onerror=()=>{n(new Error("Failed to get favorites"))}})}catch(e){throw console.error("Error getting favorites:",e),e}},async getFavorite(e){try{const t=await u();return new Promise((n,o)=>{const a=t.transaction([d],"readonly").objectStore(d).get(e);a.onsuccess=()=>{n(a.result)},a.onerror=()=>{o(new Error("Failed to get favorite"))}})}catch(e){throw console.error("Error getting favorite:",e),e}},async deleteFavorite(e){try{const t=await u();return new Promise((n,o)=>{const a=t.transaction([d],"readwrite").objectStore(d).delete(e);a.onsuccess=()=>{console.log("Story removed from favorites:",e),n()},a.onerror=()=>{o(new Error("Failed to delete favorite"))}})}catch(e){throw console.error("Error deleting favorite:",e),e}},async isFavorite(e){try{return!!await this.getFavorite(e)}catch(e){return console.error("Error checking favorite:",e),!1}},async toggleFavorite(e){try{return await this.isFavorite(e.id)?(await this.deleteFavorite(e.id),!1):(await this.addFavorite(e),!0)}catch(e){throw console.error("Error toggling favorite:",e),e}}},g={render:async()=>'\n      <section class="home-page">\n        <h2>üåè Peta Lokasi Wisata Indonesia</h2>\n        <p>\n          Temukan dan jelajahi berbagai destinasi wisata menarik di seluruh Indonesia, lengkap dengan lokasi peta dan cerita dari para wisatawan.\n        </p>\n\n        <div id="map-home" class="map-container"></div>\n\n        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">\n          <h3 style="font-size: 1.75rem; color: var(--text-main);">üó∫Ô∏è Daftar Lokasi Wisata</h3>\n          <div style="display: flex; gap: 1rem; align-items: center;">\n            <button id="reload-btn" class="btn-secondary" style="padding: 0.75rem 1.5rem; background-color: #64748b; color: white; border: none; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">\n              üîÑ Reload\n            </button>\n            <a href="#/add-story" class="btn-primary" style="width: auto; padding: 0.75rem 1.5rem; text-decoration: none;">\n              + Tambah Cerita\n            </a>\n          </div>\n        </div>\n\n        <div id="story-list" class="story-list"></div>\n      </section>\n    ',async afterRender(){console.log("HomePage afterRender called"),this.map=L.map("map-home").setView(a.DEFAULT_COORDINATE,a.DEFAULT_ZOOM),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(this.map),this.markerLayer=L.layerGroup().addTo(this.map);const e=document.querySelector("#reload-btn");e&&e.addEventListener("click",async()=>{e.disabled=!0,e.innerHTML="üîÑ Loading...",await this._loadStories(),e.disabled=!1,e.innerHTML="üîÑ Reload"}),await this._loadStories()},async _loadStories(){try{const e=await c.getAllStories();console.log("Stories fetched:",e);const t=document.querySelector("#story-list");if(t.innerHTML="",this.markerLayer.clearLayers(),!e||0===e.length)return void(t.innerHTML='\n          <div class="error-message">\n            Tidak ada cerita ditemukan.\n          </div>\n        ');for(const n of e){const e=document.createElement("div");e.classList.add("story-card");const o=n.id,a=await m.isFavorite(o)?"‚ù§Ô∏è":"ü§ç";e.innerHTML=`\n          <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">\n            <button class="favorite-btn" data-story-id="${o}" aria-label="Toggle favorite" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">\n              <span class="heart-icon" style="font-size: 1.2rem;">${a}</span>\n            </button>\n          </div>\n          <img src="${n.photoUrl}" alt="${n.name}" loading="lazy" />\n          <div class="story-info">\n            <h3>${n.name}</h3>\n            <span class="story-date">${new Date(n.createdAt).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})}</span>\n            <p>${n.description.substring(0,100)}...</p>\n            <a href="#/story/${o}" data-story-id="${o}">\n               Lihat Detail\n            </a>\n          </div>\n        `,t.appendChild(e);const i=e.querySelector(".favorite-btn");i.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();try{const e=await m.toggleFavorite(n);i.querySelector(".heart-icon").textContent=e?"‚ù§Ô∏è":"ü§ç",this._showNotification(e?"Ditambahkan ke favorit!":"Dihapus dari favorit!",e?"success":"info")}catch(e){console.error("Error toggling favorite:",e),this._showNotification("Gagal mengubah favorit","error")}}),n.lat&&n.lon&&L.marker([n.lat,n.lon]).addTo(this.markerLayer).bindPopup(`\n              <div class="leaflet-popup-content">\n                <img src="${n.photoUrl}" alt="${n.name}" />\n                <h4>${n.name}</h4>\n                <p>${n.description.substring(0,80)}...</p>\n                <a href="#/story/${o}">Lihat Detail</a>\n              </div>\n            `)}}catch(e){console.error("Error in HomePage:",e);const t=document.querySelector("#story-list");e.message&&e.message.includes("Invalid token")?(t.innerHTML='\n          <div class="text-center py-10">\n            <p class="text-red-600 font-medium mb-2">Token login tidak valid. Silakan login ulang.</p>\n            <a href="#/login" class="text-blue-600 hover:text-blue-800 underline">Login di sini</a>\n          </div>\n        ',localStorage.removeItem("token")):t.innerHTML='<p class="text-center text-gray-500 py-10">Gagal memuat cerita.</p>'}},_showNotification(e,t="info"){const n=document.createElement("div");n.className=`notification notification-${t}`,n.textContent=e,n.style.cssText=`\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      background: ${"success"===t?"#10b981":"error"===t?"#ef4444":"#3b82f6"};\n      color: white;\n      padding: 1rem 1.5rem;\n      border-radius: 0.5rem;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      z-index: 10000;\n      animation: slideIn 0.3s ease-out;\n    `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out",setTimeout(()=>n.remove(),300)},3e3)}},p={"/":g,"/home":g,"/about":{render:async()=>'\n      <section class="about-page">\n        <h2>Tentang Aplikasi</h2>\n        <p>Aplikasi ini adalah platform untuk berbagi cerita wisata di Indonesia menggunakan peta interaktif. Dibangun dengan teknologi modern seperti Leaflet untuk peta dan API Dicoding untuk autentikasi.</p>\n        <p>Temukan destinasi wisata terbaik dan bagikan pengalaman Anda kepada dunia!</p>\n      </section>\n    ',async afterRender(){}},"/login":{render:async()=>'\n      <section class="auth-page">\n        <h2>Login</h2>\n        <h2 class="sr-only">Form Login Pengguna</h2>\n        <form id="loginForm" class="auth-form">\n          <div class="form-group">\n            <label for="email">Email</label>\n            <input id="email" type="email" required aria-required="true" />\n          </div>\n          <div class="form-group">\n            <label for="password">Password</label>\n            <input id="password" type="password" required aria-required="true" />\n          </div>\n          <button type="submit" class="btn-primary">Login</button>\n          <p>Belum punya akun? <a href="#/register">Register</a></p>\n        </form>\n        <div id="error-message" class="error-message" role="alert"></div>\n      </section>\n    ',async afterRender(){const e=document.querySelector("#loginForm"),t=document.querySelector("#error-message");e.addEventListener("submit",async e=>{e.preventDefault();const n=document.querySelector("#email").value.trim(),o=document.querySelector("#password").value.trim();if(n&&o)try{const e=await c.loginUser({email:n,password:o});s({name:e.loginResult.name,email:n,token:e.loginResult.token}),window.location.hash="/"}catch(e){t.textContent=e.message||"Login gagal."}else t.textContent="Email dan password wajib diisi."})}},"/register":{render:async()=>'\n      <section class="auth-page">\n        <h2>Register</h2>\n        <h2 class="sr-only">Form Registrasi Pengguna Baru</h2>\n        <form id="registerForm" class="auth-form">\n          <div class="form-group">\n            <label for="name">Nama</label>\n            <input id="name" type="text" required aria-required="true" />\n          </div>\n          <div class="form-group">\n            <label for="email">Email</label>\n            <input id="email" type="email" required aria-required="true" />\n          </div>\n          <div class="form-group">\n            <label for="password">Password</label>\n            <input id="password" type="password" required aria-required="true" />\n          </div>\n          <button type="submit" class="btn-primary">Register</button>\n          <p>Sudah punya akun? <a href="#/login">Login</a></p>\n        </form>\n        <div id="error-message" class="error-message" role="alert"></div>\n      </section>\n    ',async afterRender(){const e=document.querySelector("#registerForm"),t=document.querySelector("#error-message");e.addEventListener("submit",async e=>{e.preventDefault();const n=document.querySelector("#name").value.trim(),o=document.querySelector("#email").value.trim(),a=document.querySelector("#password").value.trim();if(n&&o&&a)try{await c.registerUser({name:n,email:o,password:a}),alert("Registrasi berhasil! Silakan login."),window.location.hash="/login"}catch(e){t.textContent=e.message||"Registrasi gagal."}else t.textContent="Semua field wajib diisi."})}},"/add-story":{render:async()=>'\n      <section class="add-story-page">\n        <h2>Tambah Cerita Baru</h2>\n        <h2 class="sr-only">Form Tambah Cerita Wisata</h2>\n        <form id="storyForm" class="story-form" enctype="multipart/form-data">\n          <div class="form-group">\n            <label for="description">Deskripsi</label>\n            <textarea id="description" rows="4" placeholder="Tuliskan cerita anda..." required aria-required="true"></textarea>\n          </div>\n          <div class="form-group">\n            <label for="photo">Unggah Foto</label>\n            <input id="photo" type="file" accept="image/*" required aria-required="true" />\n          </div>\n          <div class="form-group">\n            <label>Pilih Lokasi di Peta</label>\n            <div id="map-add" class="map-select" role="application" aria-label="Peta untuk memilih lokasi"></div>\n          </div>\n          <button type="submit" class="btn-primary">Kirim Cerita</button>\n        </form>\n      </section>\n    ',async afterRender(){const e=l();if(!e||!e.token)return alert("Silakan login terlebih dahulu untuk menambahkan cerita."),void(window.location.hash="/login");let t=null,n=null;(()=>{const e=L.map("map-add").setView(a.DEFAULT_COORDINATE,a.DEFAULT_ZOOM);let o;L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(e),e.on("click",a=>{const{lat:i,lng:r}=a.latlng;o&&e.removeLayer(o),o=L.marker([i,r]).addTo(e),((e,o)=>{t=e,n=o})(i,r)})})(),document.querySelector("#storyForm").addEventListener("submit",async e=>{e.preventDefault();const o=document.querySelector("#description").value.trim(),a=document.querySelector("#photo").files[0];if(o&&a&&t&&n)try{const e=await c.addStory({description:o,photo:a,lat:t,lon:n});e.error?alert(`Gagal: ${e.message}`):(await this.showSuccessNotification(o),alert("Cerita berhasil ditambahkan!"),window.location.hash="/")}catch(e){alert("Terjadi kesalahan."),console.error(e)}else alert("Semua kolom wajib diisi, termasuk lokasi!")})},async showSuccessNotification(e){try{if(!("Notification"in window))return void console.warn("Browser tidak support notifikasi");let t=Notification.permission;if("default"===t&&(t=await Notification.requestPermission()),"granted"!==t)return void console.warn("Notifikasi tidak diizinkan");if("serviceWorker"in navigator){const t=await navigator.serviceWorker.ready;await t.showNotification("Cerita Berhasil Ditambahkan! üéâ",{body:e.substring(0,100)+"...",icon:"/public/icons/icon-192x192.png",badge:"/public/icons/icon-192x192.png",tag:"story-added",requireInteraction:!1,vibrate:[200,100,200],data:{url:"/#/",timestamp:Date.now()},actions:[{action:"view",title:"üëÅÔ∏è Lihat Cerita"},{action:"close",title:"‚ùå Tutup"}]}),console.log("‚úÖ Notifikasi ditampilkan")}}catch(e){console.error("Error showing notification:",e)}}},"/story/:id":{render:async()=>'\n      <section class="detail-story-page">\n        <div id="story-detail" class="story-detail">\n          <div class="text-center py-10">\n            <p>Memuat detail cerita...</p>\n          </div>\n        </div>\n      </section>\n    ',async afterRender(){const e=t.parseActiveUrlWithoutCombiner(),n=window.location.hash;console.log("[DetailStoryPage] Raw Hash:",n),console.log("[DetailStoryPage] Parsed URL:",e);const o=n.replace("#/","").split("/")[1]||e.id;if(console.log("[DetailStoryPage] Final Story ID to fetch:",o),o)try{console.log("[DetailStoryPage] Fetching story with ID:",o);const e=await c.getStoryDetail(o);if(!e)throw new Error("Cerita tidak ditemukan di server.");const{name:t,description:n,photoUrl:a,lat:i,lon:r,createdAt:s}=e;document.querySelector("#story-detail").innerHTML=`\n        <h2>${t}</h2>\n        <div class="story-card detail-content">\n          <img src="${a}" alt="${t}" class="story-image"/>\n          <div class="story-info">\n            <span class="story-date" style="font-size: 1rem; margin-bottom: 1.5rem;">\n              üìÖ ${new Date(s).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})}\n            </span>\n            <h3>Deskripsi</h3>\n            <p>${n}</p>\n            ${i&&r?'\n              <h3>Lokasi</h3>\n              <div id="map-detail" class="map-container"></div>\n            ':""}\n            <a href="#/" class="btn-primary" style="display: inline-block; width: auto; margin-top: 1.5rem; text-decoration: none;">\n              ‚Üê Kembali ke Beranda\n            </a>\n          </div>\n        </div>\n      `,i&&r&&setTimeout(()=>{((e,t)=>{const n=L.map("map-detail").setView([e,t],15);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(n),L.marker([e,t]).addTo(n)})(i,r)},100),console.log("[DetailStoryPage] ‚úÖ Cerita berhasil dimuat:",t)}catch(e){console.error("[DetailStoryPage] ‚ùå Gagal memuat detail:",e),document.querySelector("#story-detail").innerHTML=`\n        <h2>Detail Cerita</h2>\n        <div class="text-center py-10">\n          <p class="error-message">‚ùå Gagal memuat detail cerita.</p>\n          <p class="text-muted"><strong>Error:</strong> ${e.message}</p>\n          <p class="text-muted"><strong>Story ID:</strong> ${o}</p>\n          <p class="text-muted"><strong>URL:</strong> ${n}</p>\n          <a href="#/" class="btn-primary" style="display: inline-block; width: auto; margin-top: 1rem; text-decoration: none;">\n            ‚Üê Kembali ke Beranda\n          </a>\n        </div>\n      `}else document.querySelector("#story-detail").innerHTML=`\n        <h2>Detail Cerita</h2>\n        <p class="error-message">‚ùå ID cerita tidak ditemukan di URL.</p>\n        <p class="text-muted">URL: ${n}</p>\n        <a href="#/" class="btn-primary" style="display: inline-block; width: auto; margin-top: 1rem; text-decoration: none;">\n          ‚Üê Kembali ke Beranda\n        </a>\n      `}},"/favorites":{render:async()=>'\n      <section class="favorites-page">\n        <div class="page-header">\n          <h2>‚ù§Ô∏è Favorit Saya</h2>\n          <p>Daftar destinasi wisata yang telah Anda simpan sebagai favorit</p>\n        </div>\n\n        <div id="favorites-map" class="map-container"></div>\n\n        <div class="section-header" style="margin-bottom: 2rem;">\n          <h3 style="font-size: 1.75rem; color: var(--text-main);">üìå Daftar Favorit</h3>\n          <span id="favorites-count" class="badge">0 Favorit</span>\n        </div>\n\n        <div id="favorites-list" class="story-list"></div>\n      </section>\n    ',async afterRender(){console.log("FavoritesPage afterRender called");const e=L.map("favorites-map").setView(a.DEFAULT_COORDINATE,a.DEFAULT_ZOOM);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(e),await this._loadFavorites(e)},async _loadFavorites(e){const t=document.querySelector("#favorites-list"),n=document.querySelector("#favorites-count");try{const o=await m.getAllFavorites();if(console.log("Favorites loaded:",o),!o||0===o.length)return t.innerHTML='\n          <div class="empty-state">\n            <div style="font-size: 4rem; margin-bottom: 1rem;">üíî</div>\n            <h3 style="color: var(--text-main); margin-bottom: 0.5rem;">Belum Ada Favorit</h3>\n            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">\n              Anda belum menyimpan destinasi wisata apapun sebagai favorit.\n            </p>\n            <a href="#/" class="btn-primary" style="text-decoration: none; display: inline-block;">\n              Jelajahi Destinasi\n            </a>\n          </div>\n        ',void(n.textContent="0 Favorit");n.textContent=`${o.length} Favorit`,t.innerHTML="",o.forEach(n=>{const o=document.createElement("div");o.classList.add("story-card"),o.dataset.storyId=n.id,o.innerHTML=`\n          <img src="${n.photoUrl}" alt="${n.name}" loading="lazy" />\n          <div class="story-info">\n            <h3>${n.name}</h3>\n            <p>${n.description.substring(0,100)}...</p>\n            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">\n              <a href="#/story/${n.id}" class="btn-secondary" style="text-decoration: none; flex: 1; text-align: center;">\n                Lihat Detail\n              </a>\n              <button class="btn-remove-favorite" data-id="${n.id}" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">\n                üóëÔ∏è Hapus\n              </button>\n            </div>\n          </div>\n        `,t.appendChild(o),n.lat&&n.lon&&L.marker([n.lat,n.lon]).addTo(e).bindPopup(`\n              <div class="leaflet-popup-content">\n                <img src="${n.photoUrl}" alt="${n.name}" />\n                <h4>${n.name}</h4>\n                <p>${n.description.substring(0,80)}...</p>\n                <a href="#/story/${n.id}">Lihat Detail</a>\n              </div>\n            `)}),this._initRemoveButtons(e)}catch(e){console.error("Error loading favorites:",e),t.innerHTML='\n        <div class="error-message">\n          <p>Gagal memuat favorit. Silakan coba lagi.</p>\n        </div>\n      '}},_initRemoveButtons(e){document.querySelectorAll(".btn-remove-favorite").forEach(t=>{t.addEventListener("click",async t=>{const n=t.target.dataset.id;if(confirm("Apakah Anda yakin ingin menghapus dari favorit?"))try{await m.deleteFavorite(n),this._showNotification("Berhasil dihapus dari favorit!","success"),await this._loadFavorites(e)}catch(e){console.error("Error removing favorite:",e),this._showNotification("Gagal menghapus dari favorit","error")}})})},_showNotification(e,t="info"){const n=document.createElement("div");n.className=`notification notification-${t}`,n.textContent=e,n.style.cssText=`\n      position: fixed;\n      top: 80px;\n      right: 20px;\n      background: ${"success"===t?"#10b981":"#ef4444"};\n      color: white;\n      padding: 1rem 1.5rem;\n      border-radius: 0.5rem;\n      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n      z-index: 10000;\n      animation: slideIn 0.3s ease-out;\n    `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out",setTimeout(()=>n.remove(),300)},3e3)}}},h=class{constructor({button:e,drawer:t,content:n}){this._button=e,this._drawer=t,this._content=n,this._initAppShell()}_initAppShell(){e.init({button:this._button,drawer:this._drawer,content:this._content})}async renderPage(){const e=t.parseActiveUrlWithCombiner(),n=p[e];if(console.log("üîç Current URL:",window.location.hash),console.log("üîç Parsed URL:",e),console.log("üîç Found page:",!!n),!n)return console.error("‚ùå Page not found for URL:",e),void(this._content.innerHTML="<h1>Halaman tidak ditemukan üò¢</h1>");console.log("‚úÖ Rendering page for:",e),"startViewTransition"in document?(console.log("üé¨ Using View Transition API"),document.startViewTransition(async()=>{this._content.innerHTML=await n.render(),await(n.afterRender?.()),console.log("‚úÖ Page rendered successfully")})):(console.warn("‚ö†Ô∏è View Transition API not supported"),this._content.innerHTML=await n.render(),await(n.afterRender?.()),console.log("‚úÖ Page rendered successfully (fallback)"))}},y={isSupported:()=>"serviceWorker"in navigator&&"PushManager"in window,async requestPermission(){if(!this.isSupported())return console.warn("Push notification tidak didukung di browser ini"),!1;try{const e=await Notification.requestPermission();return console.log("Notification permission:",e),"granted"===e?(console.log("‚úÖ Notification permission granted"),!0):"denied"===e?(console.warn("‚ùå Notification permission denied"),!1):(console.log("‚ö†Ô∏è Notification permission dismissed"),!1)}catch(e){return console.error("Error requesting notification permission:",e),!1}},urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),o=new Uint8Array(n.length);for(let e=0;e<n.length;++e)o[e]=n.charCodeAt(e);return o},async subscribe(){if(!this.isSupported())throw new Error("Push notification tidak didukung");try{const e=await navigator.serviceWorker.ready;console.log("Service Worker ready for push subscription");let t=await e.pushManager.getSubscription();if(t)return console.log("Already subscribed to push notifications"),await this.sendSubscriptionToDicodingAPI(t),t;if(!await this.requestPermission())throw new Error("Permission tidak diberikan");const n=i.PUBLIC_VAPID_KEY,o=this.urlBase64ToUint8Array(n);return t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o}),console.log("‚úÖ Push subscription created:",t),await this.sendSubscriptionToDicodingAPI(t),localStorage.setItem("push_subscription_enabled","true"),t}catch(e){throw console.error("Error subscribing to push:",e),e}},async unsubscribe(){try{const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(!t)return void console.log("Not subscribed to push notifications");await this.deleteSubscriptionFromDicodingAPI(t),await t.unsubscribe(),console.log("‚úÖ Unsubscribed from push notifications"),localStorage.setItem("push_subscription_enabled","false")}catch(e){throw console.error("Error unsubscribing from push:",e),e}},async getSubscriptionStatus(){try{const e=await navigator.serviceWorker.ready;return!!await e.pushManager.getSubscription()}catch(e){return console.error("Error checking subscription status:",e),!1}},async sendSubscriptionToDicodingAPI(e){try{const t=JSON.parse(localStorage.getItem("dicoding_story_user")||"{}");if(!t||!t.token)return void console.warn("‚ö†Ô∏è User belum login, skip send subscription to API");const o=e.toJSON(),a={endpoint:o.endpoint,keys:{p256dh:o.keys.p256dh,auth:o.keys.auth}},i=`${n}notifications/subscribe`;console.log("üì§ Sending subscription to Dicoding API:",i),console.log("üì¶ Payload:",a);const r=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.token}`},body:JSON.stringify(a)}),s=await r.json();if(!r.ok)throw new Error(s.message||"Failed to subscribe");return console.log("‚úÖ Subscription sent to Dicoding API:",s),s}catch(e){console.error("‚ùå Error sending subscription to Dicoding API:",e)}},async deleteSubscriptionFromDicodingAPI(e){try{const e=JSON.parse(localStorage.getItem("dicoding_story_user")||"{}");if(!e||!e.token)return void console.warn("‚ö†Ô∏è User belum login, skip delete subscription from API");const t=`${n}notifications/unsubscribe`;console.log("üì§ Deleting subscription from Dicoding API:",t);const o=await fetch(t,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`}});if(!o.ok){const e=await o.json();throw new Error(e.message||"Failed to unsubscribe")}console.log("‚úÖ Subscription deleted from Dicoding API")}catch(e){console.error("‚ùå Error deleting subscription from Dicoding API:",e)}},async testNotification(){"granted"!==Notification.permission&&await this.requestPermission(),"granted"===Notification.permission&&((await navigator.serviceWorker.ready).showNotification("Test Notification üß™",{body:"Ini adalah test notification dari Peta Wisata Indonesia",icon:"/public/icons/icon-192x192.png",badge:"/public/icons/icon-192x192.png",tag:"test-notification",actions:[{action:"view",title:"Lihat"},{action:"close",title:"Tutup"}],data:{url:"/"}}),console.log("‚úÖ Test notification displayed"))}},w={async init(){const e=document.getElementById("notificationToggle");if(document.getElementById("notificationIcon"),e){if(!y.isSupported())return e.style.display="none",void console.warn("Push notification not supported in this browser");await this.updateToggleUI(),e.addEventListener("click",async()=>{await this.handleToggleClick()}),console.log("‚úÖ Notification toggle initialized")}else console.warn("Notification toggle button not found")},async updateToggleUI(){const e=document.getElementById("notificationToggle"),t=document.getElementById("notificationIcon");if(e&&t)try{const n=await y.getSubscriptionStatus(),o=Notification.permission;n&&"granted"===o?(t.textContent="üîî",e.classList.add("active"),e.setAttribute("aria-label","Disable push notifications"),e.title="Notifikasi Aktif - Klik untuk nonaktifkan"):(t.textContent="üîï",e.classList.remove("active"),e.setAttribute("aria-label","Enable push notifications"),e.title="Notifikasi Nonaktif - Klik untuk aktifkan")}catch(e){console.error("Error updating toggle UI:",e)}},async handleToggleClick(){const e=document.getElementById("notificationToggle");e.disabled=!0,this.showLoading(!0);try{await y.getSubscriptionStatus()?(await y.unsubscribe(),this.showMessage("Notifikasi dinonaktifkan","success")):(await y.subscribe(),this.showMessage("Notifikasi diaktifkan! Anda akan menerima update terbaru.","success")),await this.updateToggleUI()}catch(e){console.error("Error toggling notification:",e),e.message.includes("Permission")?this.showMessage("Izin notifikasi ditolak. Silakan aktifkan dari pengaturan browser.","error"):this.showMessage("Gagal mengaktifkan notifikasi. Silakan coba lagi.","error")}finally{e.disabled=!1,this.showLoading(!1)}},showLoading(e){const t=document.getElementById("notificationIcon");t&&e&&(t.textContent="‚è≥")},showMessage(e,t="info"){const n=document.createElement("div");n.className=`toast toast-${t}`,n.textContent=e,n.setAttribute("role","alert"),document.body.appendChild(n),setTimeout(()=>{n.classList.add("show")},100),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>{n.remove()},300)},3e3)},showPermissionDialog(){const e=document.createElement("div");e.className="permission-dialog",e.innerHTML='\n      <div class="permission-dialog-content">\n        <h3>üîî Aktifkan Notifikasi</h3>\n        <p>Dapatkan update terbaru tentang cerita wisata baru dan konten menarik lainnya.</p>\n        <div class="permission-dialog-actions">\n          <button id="allowNotification" class="btn-primary">Izinkan</button>\n          <button id="denyNotification" class="btn-secondary">Nanti Saja</button>\n        </div>\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.classList.add("show")},100),document.getElementById("allowNotification")?.addEventListener("click",async()=>{e.remove(),await this.handleToggleClick()}),document.getElementById("denyNotification")?.addEventListener("click",()=>{e.remove()})},async autoPromptIfNeeded(){localStorage.getItem("notification_prompted")||setTimeout(()=>{"default"===Notification.permission&&(this.showPermissionDialog(),localStorage.setItem("notification_prompted","true"))},5e3)}},f={deferredPrompt:null,isInstalled:!1,init(){this.checkInstallStatus(),window.addEventListener("beforeinstallprompt",e=>{console.log("[Install] üíæ beforeinstallprompt event fired"),e.preventDefault(),this.deferredPrompt=e,this.showInstallUI()}),window.addEventListener("appinstalled",()=>{console.log("[Install] ‚úÖ PWA installed successfully"),this.isInstalled=!0,this.hideInstallUI(),this.deferredPrompt=null,localStorage.setItem("pwa_installed","true"),this.showSuccessMessage()}),window.matchMedia("(display-mode: standalone)").matches&&(console.log("[Install] üì± Running in standalone mode"),this.isInstalled=!0,this.hideInstallUI())},checkInstallStatus(){const e="true"===localStorage.getItem("pwa_installed"),t=window.matchMedia("(display-mode: standalone)").matches,n=!0===window.navigator.standalone;this.isInstalled=e||t||n,this.isInstalled&&(console.log("[Install] ‚úÖ App already installed"),this.hideInstallUI())},showInstallUI(){const e=document.getElementById("install-banner");if(e)return void(e.style.display="flex");const t=document.createElement("div");t.id="install-banner",t.className="install-banner",t.innerHTML='\n      <div class="install-banner-content">\n        <div class="install-icon">üì±</div>\n        <div class="install-text">\n          <strong>Install Peta Wisata</strong>\n          <p>Akses lebih cepat dan bisa offline</p>\n        </div>\n        <button id="install-button" class="install-btn">Install</button>\n        <button id="install-close" class="install-close" aria-label="Close">‚úï</button>\n      </div>\n    ',document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},500),document.getElementById("install-button")?.addEventListener("click",()=>{this.promptInstall()}),document.getElementById("install-close")?.addEventListener("click",()=>{this.hideInstallUI(),localStorage.setItem("install_prompt_dismissed",Date.now().toString())})},hideInstallUI(){const e=document.getElementById("install-banner");e&&(e.classList.remove("show"),setTimeout(()=>{e.remove()},300))},async promptInstall(){if(!this.deferredPrompt)return console.warn("[Install] ‚ö†Ô∏è Install prompt not available"),void this.showManualInstructions();try{this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log("[Install] User choice:",e),"accepted"===e?(console.log("[Install] ‚úÖ User accepted install"),this.hideInstallUI()):console.log("[Install] ‚ùå User dismissed install"),this.deferredPrompt=null}catch(e){console.error("[Install] Error prompting install:",e)}},showManualInstructions(){let e="";e=/iPad|iPhone|iPod/.test(navigator.userAgent)?'\n        <div class="install-instructions">\n          <h3>üì± Cara Install di iOS</h3>\n          <ol>\n            <li>Tap tombol <strong>Share</strong> (ikon kotak dengan panah ke atas)</li>\n            <li>Scroll ke bawah dan tap <strong>"Add to Home Screen"</strong></li>\n            <li>Tap <strong>"Add"</strong> di pojok kanan atas</li>\n          </ol>\n        </div>\n      ':'\n        <div class="install-instructions">\n          <h3>üíª Cara Install</h3>\n          <p>Gunakan menu browser:</p>\n          <ul>\n            <li><strong>Chrome:</strong> Menu (‚ãÆ) ‚Üí Install app / Add to Home screen</li>\n            <li><strong>Edge:</strong> Menu (‚ãØ) ‚Üí Apps ‚Üí Install this site as an app</li>\n            <li><strong>Firefox:</strong> Address bar ‚Üí Install icon</li>\n          </ul>\n        </div>\n      ';const t=document.createElement("div");t.className="install-modal",t.innerHTML=`\n      <div class="install-modal-content">\n        ${e}\n        <button class="install-btn" onclick="this.closest('.install-modal').remove()">\n          Mengerti\n        </button>\n      </div>\n    `,document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&t.remove()})},showSuccessMessage(){const e=document.createElement("div");e.className="install-toast",e.innerHTML='\n      <div class="install-toast-content">\n        ‚úÖ Aplikasi berhasil diinstall!\n      </div>\n    ',document.body.appendChild(e),setTimeout(()=>{e.classList.add("show")},100),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>{e.remove()},300)},3e3)},shouldShowPrompt(){if(this.isInstalled)return!1;const e=localStorage.getItem("install_prompt_dismissed");return!(e&&(Date.now()-parseInt(e))/864e5<7)}};let v;console.log("App initialized...");const b=()=>{const e=JSON.parse(localStorage.getItem("dicoding_story_user")||"null"),t=document.querySelector("#nav-links");t&&(e?(t.classList.add("logged-in"),t.classList.remove("logged-out")):(t.classList.add("logged-out"),t.classList.remove("logged-in")))};document.addEventListener("DOMContentLoaded",()=>{b(),v=new h({button:document.querySelector("#hamburgerButton"),drawer:document.querySelector("#navigationDrawer"),content:document.querySelector("#main-content")});const e=document.querySelector("#logout-btn");e&&e.addEventListener("click",e=>{e.preventDefault(),confirm("Apakah Anda yakin ingin logout?")&&(localStorage.clear(),window.location.hash="/",b())}),window.addEventListener("hashchange",async()=>{console.log("Route changed:",window.location.hash),await v.renderPage(),b()}),window.addEventListener("load",async()=>{console.log("Window loaded"),await v.renderPage(),await(async()=>{if("serviceWorker"in navigator){Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.\d{1,3}){3}$/))&&console.log("üß© Mode development terdeteksi (localhost). SW tetap dijalankan untuk testing.");try{const e=await navigator.serviceWorker.register("/sw.js");console.log("‚úÖ Service Worker registered successfully."),console.log("Scope:",e.scope),e.onupdatefound=()=>{const t=e.installing;t&&(t.onstatechange=()=>{"installed"===t.state&&(navigator.serviceWorker.controller?(console.log("üîÑ Update baru tersedia untuk Service Worker."),t.postMessage({type:"SKIP_WAITING"}),t.addEventListener("statechange",()=>{"activated"===t.state&&window.location.reload()})):console.log("üéâ Service Worker siap untuk penggunaan offline."))})},navigator.serviceWorker.controller&&console.log("üí° Active Service Worker found.")}catch(e){console.error("‚ùå Service Worker registration failed:",e),e.message&&e.message.includes("storage")&&console.warn("‚ö†Ô∏è Failed to access storage. Coba clear site data dari Application tab.")}}else console.warn("‚ö†Ô∏è Service Worker tidak didukung di browser ini.")})();try{await w.init()}catch(e){console.warn("Notification init failed:",e)}f.init()})})})();
//# sourceMappingURL=main.151f2165b6384cfdffde.bundle.js.map