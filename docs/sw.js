const CACHE_VERSION="v2.0.2",CACHE_PREFIX="peta-wisata",CACHES={STATIC:`${CACHE_PREFIX}-static-v2.0.2`,DYNAMIC:`${CACHE_PREFIX}-dynamic-v2.0.2`,IMAGES:`${CACHE_PREFIX}-images-v2.0.2`,API:`${CACHE_PREFIX}-api-v2.0.2`},STATIC_ASSETS=["/","/index.html","/offline.html","/images/icons/icon-192x192.png","/images/icons/icon-512x512.png"],API_BASE_URL="https://story-api.dicoding.dev/v1",API_CACHE_DURATION=3e5;async function cacheFirst(e,t){const i=await caches.match(e);if(i)return console.log("[Service Worker] ğŸ“¦ From cache:",e.url),i;try{const i=await fetch(e);return"GET"===e.method&&((await caches.open(t)).put(e,i.clone()),console.log("[Service Worker] ğŸŒ From network (cached):",e.url)),i}catch(t){return console.error("[Service Worker] âŒ Fetch failed:",t),getOfflineFallback(e)}}async function staleWhileRevalidate(e,t){const i=await caches.match(e),n=fetch(e).then(i=>(caches.open(t).then(t=>{"GET"===e.method&&(t.put(e,i.clone()),console.log("[Service Worker] ğŸ”„ Cache updated:",e.url))}),i)).catch(t=>{if(console.error("[Service Worker] âŒ Network failed:",t),!i)return getOfflineFallback(e)});return i||n}async function networkFirstWithCache(e,t){try{console.log("[Service Worker] ğŸŒ Fetching:",e.method,e.url);const i=await fetch(e);return i&&200===i.status&&"GET"===e.method&&((await caches.open(t)).put(e,i.clone()),console.log("[Service Worker] ğŸ’¾ Cached:",e.url)),i}catch(t){if(console.log("[Service Worker] âŒ Network failed:",e.method,e.url),"GET"!==e.method)throw console.log("[Service Worker] âš ï¸ Non-GET request failed, throwing error"),t;const i=await caches.match(e);return i?(console.log("[Service Worker] ğŸ“¦ Returning cached response"),i):getOfflineFallback(e)}}function isStaticAsset(e){return e.pathname.endsWith(".css")||e.pathname.endsWith(".js")||e.pathname.endsWith(".woff2")||"/"===e.pathname||"/index.html"===e.pathname||e.pathname.startsWith("/images/icons/")}function isApiRequest(e){return e.href.includes(API_BASE_URL)}function isImageRequest(e){return e.pathname.endsWith(".png")||e.pathname.endsWith(".jpg")||e.pathname.endsWith(".jpeg")||e.pathname.endsWith(".gif")||e.pathname.endsWith(".webp")||e.pathname.endsWith(".svg")}async function getOfflineFallback(e){return"document"===e.destination?caches.match("/offline.html"):isImageRequest(new URL(e.url))?new Response('<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="#e2e8f0"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="#64748b">Offline</text></svg>',{headers:{"Content-Type":"image/svg+xml"}}):isApiRequest(new URL(e.url))?new Response(JSON.stringify({error:!0,message:"Offline - Data dari cache",offline:!0}),{headers:{"Content-Type":"application/json"},status:503}):new Response("Offline",{status:503})}self.addEventListener("install",e=>{console.log("[Service Worker] ğŸ“¦ Installing v2.0.2..."),e.waitUntil(caches.open(CACHES.STATIC).then(e=>(console.log("[Service Worker] ğŸ’¾ Caching static assets"),Promise.all(STATIC_ASSETS.map(t=>e.add(t).catch(e=>{console.warn(`[Service Worker] âš ï¸ Failed to cache ${t}:`,e)}))))).then(()=>{console.log("[Service Worker] âœ… Static assets cached")}).catch(e=>{console.error("[Service Worker] âŒ Install failed:",e)})),self.skipWaiting()}),self.addEventListener("activate",e=>(console.log("[Service Worker] ğŸš€ Activating v2.0.2..."),e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e.startsWith(CACHE_PREFIX)&&!Object.values(CACHES).includes(e))return console.log("[Service Worker] ğŸ—‘ï¸ Deleting old cache:",e),caches.delete(e)}))).then(()=>{console.log("[Service Worker] âœ… Old caches cleaned")})),self.clients.claim())),self.addEventListener("fetch",e=>{const{request:t}=e,i=new URL(t.url);t.url.startsWith("http")&&(isStaticAsset(i)?e.respondWith(networkFirstWithCache(t,CACHES.STATIC)):isApiRequest(i)?e.respondWith(networkFirstWithCache(t,CACHES.API)):isImageRequest(i)?e.respondWith(networkFirstWithCache(t,CACHES.IMAGES)):e.respondWith(networkFirstWithCache(t,CACHES.DYNAMIC)))}),self.addEventListener("push",e=>{console.log("[Service Worker] ğŸ”” Push received");let t={title:"Peta Wisata Indonesia",body:"Ada update baru!",icon:"/images/icons/icon-192x192.png",badge:"/images/icons/icon-192x192.png",data:{url:"/"}};if(e.data)try{const i=e.data.json();t={title:i.title||t.title,body:i.body||t.body,icon:i.icon||t.icon,badge:i.badge||t.badge,image:i.image,tag:i.tag||"default",data:{url:i.url||"/",storyId:i.storyId},actions:i.actions||[{action:"view",title:"ğŸ‘ï¸ Lihat"},{action:"close",title:"âŒ Tutup"}]}}catch(e){console.error("[Service Worker] Push parse error:",e)}e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:t.icon,badge:t.badge,image:t.image,tag:t.tag,data:t.data,actions:t.actions,vibrate:[200,100,200]}))}),self.addEventListener("notificationclick",e=>{if(e.notification.close(),"close"===e.action)return;const t=e.notification.data.url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(e=>{for(const i of e)if("focus"in i)return i.focus().then(()=>i.postMessage({type:"NAVIGATE",url:t}));if(clients.openWindow)return clients.openWindow(t)}))}),self.addEventListener("message",e=>{e.data&&"SKIP_WAITING"===e.data.type&&self.skipWaiting()}),console.log("[Service Worker] ğŸš€ Loaded v2.0.2");